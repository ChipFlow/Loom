<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Timing Violations - Loom Documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Loom Documentation</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/ChipFlow/Loom" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="timing-violation-detection"><a class="header" href="#timing-violation-detection">Timing Violation Detection</a></h1>
<p>Guide to enabling, reading, and debugging setup/hold timing violations in GEM.</p>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>Setup and hold violations occur when data arrives too late (setup) or too early (hold) relative to the clock edge at a flip-flop. GEM checks for these violations during GPU simulation by tracking <strong>arrival times</strong> — the accumulated gate delay from primary inputs or DFF outputs through combinational logic to the next DFF data input.</p>
<p><strong>Approximation model</strong>: GEM tracks one arrival time per 32-signal group (one GPU thread position). The arrival is the <strong>maximum</strong> across all 32 signals in the group. This is conservative: it may over-report violations but will never miss a real one. See <a href="#the-approximation-caveat">Reducing False Positives</a> for details.</p>
<h2 id="enabling-timing-checks"><a class="header" href="#enabling-timing-checks">Enabling Timing Checks</a></h2>
<h3 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h3>
<ol>
<li><strong>SDF file</strong> with back-annotated delays from your place-and-route tool</li>
<li><strong>Gate-level netlist</strong> synthesized to <code>aigpdk.lib</code> cells</li>
<li><strong>Compiled <code>.gemparts</code></strong> file from <code>loom map</code></li>
</ol>
<h3 id="step-by-step"><a class="header" href="#step-by-step">Step-by-step</a></h3>
<ol>
<li>
<p><strong>Generate SDF</strong> from your P&amp;R tool (or use <code>scripts/generate_sdf.py</code> for test designs):</p>
<pre><code class="language-bash"># Example: OpenROAD flow output
ls my_build/6_final.sdf
</code></pre>
</li>
<li>
<p><strong>Run the simulator</strong> with <code>--sdf</code> and a clock period:</p>
<p><strong>Metal (macOS)</strong>:</p>
<pre><code class="language-bash">cargo run -r --features metal --bin loom -- sim \
    design.gv design.gemparts input.vcd output.vcd 1 \
    --sdf design.sdf \
    --sdf-corner typ
</code></pre>
<p><strong>CUDA (NVIDIA)</strong>:</p>
<pre><code class="language-bash">cargo run -r --features cuda --bin loom -- sim \
    design.gv design.gemparts input.vcd output.vcd 8 \
    --sdf design.sdf \
    --sdf-corner typ \
    --enable-timing \
    --timing-clock-period 1200
</code></pre>
<p><strong>gpu_sim (co-simulation)</strong>:</p>
<pre><code class="language-bash">cargo run -r --features metal --bin gpu_sim -- \
    design.gv design.gemparts \
    --config testbench.json \
    --sdf design.sdf \
    --sdf-corner typ
</code></pre>
</li>
</ol>
<h3 id="cli-flags-reference"><a class="header" href="#cli-flags-reference">CLI Flags Reference</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Flag</th><th>Binary</th><th>Description</th></tr></thead><tbody>
<tr><td><code>--sdf &lt;path&gt;</code></td><td>all</td><td>Path to SDF file with back-annotated delays</td></tr>
<tr><td><code>--sdf-corner &lt;min|typ|max&gt;</code></td><td>all</td><td>Which SDF corner to use (default: <code>typ</code>)</td></tr>
<tr><td><code>--sdf-debug</code></td><td>all</td><td>Print unmatched SDF instances for debugging</td></tr>
<tr><td><code>--enable-timing</code></td><td><code>loom sim</code></td><td>Enable timing analysis (arrival + violation checks)</td></tr>
<tr><td><code>--timing-clock-period &lt;ps&gt;</code></td><td><code>loom sim</code></td><td>Clock period in picoseconds (default: 1000)</td></tr>
<tr><td><code>--timing-report-violations</code></td><td><code>loom sim</code></td><td>Report all violations, not just summary</td></tr>
<tr><td><code>--liberty &lt;path&gt;</code></td><td><code>loom sim</code></td><td>Liberty library for timing data (optional, falls back to AIGPDK defaults)</td></tr>
</tbody></table>
</div>
<h3 id="example-inv_chain_pnr-test-case"><a class="header" href="#example-inv_chain_pnr-test-case">Example: inv_chain_pnr Test Case</a></h3>
<pre><code class="language-bash"># Map the design
cargo run -r --features metal --bin loom -- map \
    tests/timing_test/inv_chain_pnr/6_final.v \
    tests/timing_test/inv_chain_pnr/inv_chain.gemparts

# Run with SDF timing
cargo run -r --features metal --bin loom -- sim \
    tests/timing_test/inv_chain_pnr/6_final.v \
    tests/timing_test/inv_chain_pnr/inv_chain.gemparts \
    tests/timing_test/inv_chain_pnr/input.vcd \
    tests/timing_test/inv_chain_pnr/output.vcd 1 \
    --sdf tests/timing_test/inv_chain_pnr/6_final.sdf
</code></pre>
<h2 id="reading-violation-reports"><a class="header" href="#reading-violation-reports">Reading Violation Reports</a></h2>
<h3 id="setup-violation-format"><a class="header" href="#setup-violation-format">Setup Violation Format</a></h3>
<pre><code>[cycle 42] SETUP VIOLATION: word 5 arrival=900ps setup=200ps slack=-100ps
</code></pre>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Meaning</th></tr></thead><tbody>
<tr><td><strong>cycle</strong></td><td>Simulation cycle where the violation occurred</td></tr>
<tr><td><strong>word</strong></td><td>State word index — identifies a group of 32 DFF data inputs</td></tr>
<tr><td><strong>arrival</strong></td><td>Maximum accumulated gate delay to this word's signals (picoseconds)</td></tr>
<tr><td><strong>setup</strong></td><td>DFF setup time constraint from SDF/Liberty (picoseconds)</td></tr>
<tr><td><strong>slack</strong></td><td><code>clock_period - arrival - setup</code>. Negative = violation amount</td></tr>
</tbody></table>
</div>
<h3 id="hold-violation-format"><a class="header" href="#hold-violation-format">Hold Violation Format</a></h3>
<pre><code>[cycle 11] HOLD VIOLATION: word 3 arrival=10ps hold=50ps slack=-40ps
</code></pre>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Meaning</th></tr></thead><tbody>
<tr><td><strong>cycle</strong></td><td>Simulation cycle where the violation occurred</td></tr>
<tr><td><strong>word</strong></td><td>State word index</td></tr>
<tr><td><strong>arrival</strong></td><td>Accumulated gate delay to this word's signals (picoseconds)</td></tr>
<tr><td><strong>hold</strong></td><td>DFF hold time constraint from SDF/Liberty (picoseconds)</td></tr>
<tr><td><strong>slack</strong></td><td><code>arrival - hold</code>. Negative = violation amount</td></tr>
</tbody></table>
</div>
<h3 id="summary-statistics"><a class="header" href="#summary-statistics">Summary Statistics</a></h3>
<p>At the end of simulation, GEM prints totals:</p>
<pre><code>Simulation complete: 1000 cycles, 5 setup violations, 0 hold violations
</code></pre>
<h2 id="tracing-violations-to-source-signals"><a class="header" href="#tracing-violations-to-source-signals">Tracing Violations to Source Signals</a></h2>
<p>When you see a violation on a specific word, follow this workflow to identify the offending signals and their logic cone.</p>
<h3 id="1-get-the-word-index"><a class="header" href="#1-get-the-word-index">1. Get the Word Index</a></h3>
<p>From the log: <code>word 5</code> means state word index 5.</p>
<h3 id="2-map-word-to-dff-signals"><a class="header" href="#2-map-word-to-dff-signals">2. Map Word to DFF Signals</a></h3>
<p>Each word covers 32 bits of state. The DFFs in that word have <code>data_state_pos / 32 == word_index</code>. To find which DFFs:</p>
<ul>
<li>
<p>Look at the <code>dff_constraints</code> entries in the <code>FlattenedScriptV1</code>:</p>
<pre><code>dff_constraints entries where data_state_pos / 32 == 5
→ cell_id values → netlist cell names
</code></pre>
</li>
<li>
<p>In <code>gpu_sim</code>, violations are logged with word IDs that map directly to the <code>output_map</code> positions. Each word covers bit positions <code>word * 32</code> through <code>word * 32 + 31</code>.</p>
</li>
</ul>
<h3 id="3-trace-backwards-with-netlist_graph"><a class="header" href="#3-trace-backwards-with-netlist_graph">3. Trace Backwards with netlist_graph</a></h3>
<p>Use the <a href="../scripts/netlist_graph/">netlist_graph tool</a> to trace the combinational logic cone feeding the DFF:</p>
<pre><code class="language-bash">cd scripts/netlist_graph

# Find the DFF data input driver chain
uv run netlist-graph drivers design.v "dff_name.D" -d 10

# Search for DFFs matching a pattern
uv run netlist-graph search design.v "dff_out*"
</code></pre>
<h3 id="4-detailed-cpu-timing-analysis"><a class="header" href="#4-detailed-cpu-timing-analysis">4. Detailed CPU Timing Analysis</a></h3>
<p>For per-signal accuracy (no 32-signal approximation), use <code>timing_sim_cpu</code>:</p>
<pre><code class="language-bash"># Generate a watchlist for signals of interest
cd scripts/netlist_graph
uv run netlist-graph watchlist design.v watch.json dff_name signal1 signal2

# Run CPU timing simulation with per-signal tracing
cargo run -r --bin timing_sim_cpu -- design.v input.vcd \
    --liberty sky130.lib --clock-period 1200 \
    --watchlist watch.json --trace-output trace.csv
</code></pre>
<p>The CSV trace shows per-cycle arrival times for each watched signal, allowing you to pinpoint exactly which path is critical.</p>
<h2 id="the-approximation-caveat"><a class="header" href="#the-approximation-caveat">The Approximation Caveat</a></h2>
<p>GEM tracks <strong>one arrival time per 32-signal group</strong> (one GPU thread position). The tracked value is the maximum arrival across all 32 signals in that thread. This means:</p>
<ul>
<li><strong>Conservative</strong>: If any signal in the group has a long path, the arrival for the entire group reflects that worst case. Violations may be reported for signals that individually meet timing.</li>
<li><strong>Never misses real violations</strong>: A real violation always results in a reported violation (the max is &gt;= any individual signal's arrival).</li>
</ul>
<h3 id="reducing-false-positives"><a class="header" href="#reducing-false-positives">Reducing False Positives</a></h3>
<p>If a violation is reported but you suspect it's a false positive from the approximation:</p>
<ol>
<li><strong>Use <code>timing_sim_cpu</code></strong> for per-signal accuracy (see <a href="#4-detailed-cpu-timing-analysis">Detailed CPU Timing Analysis</a> above).</li>
<li><strong>Timing-aware bit packing</strong> groups signals with similar arrival times into the same thread, reducing the approximation error. See <code>docs/timing-simulation.md</code> § "Timing-Aware Bit Packing" for details.</li>
</ol>
<h2 id="common-scenarios"><a class="header" href="#common-scenarios">Common Scenarios</a></h2>
<p><strong>Setup violations on many words, same cycle</strong>: The clock period is likely too tight for the design. The combinational logic depth exceeds what can settle in one clock period. Try increasing the clock period.</p>
<p><strong>Setup violation on a single word</strong>: A critical path through one specific logic cone. Use <code>netlist_graph drivers</code> to trace the path and identify the bottleneck.</p>
<p><strong>Hold violation</strong>: Rare with SKY130 process (negative hold times clamp to 0 in the SDF). If seen, the design likely has minimum-delay paths that are too short. Check for direct connections between DFF outputs and nearby DFF inputs with minimal combinational logic.</p>
<p><strong>Violations only on first cycle</strong>: The <code>arrival &gt; 0</code> guard in the GPU kernel skips setup checks when arrival is zero (meaning no data has propagated through combinational logic yet). If you see violations on cycle 0, they are hold violations — setup violations on cycle 0 are suppressed by design.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="timing-simulation.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="troubleshooting-vcd.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="timing-simulation.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="troubleshooting-vcd.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
