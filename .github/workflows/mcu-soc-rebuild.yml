name: MCU SoC P&R Rebuild

on:
  repository_dispatch:
    types: [librelane-updated]
  push:
    branches: [main]
    paths:
      - 'designs/mcu_soc_sky130/**'
      - 'sram/**'
      - 'scripts/openlane2/**'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  rebuild:
    name: Rebuild MCU SoC Test Data
    runs-on: ubuntu-latest
    timeout-minutes: 240
    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost
          sudo apt-get clean
          df -h /

      - name: Create swap space
        run: |
          sudo swapoff /swapfile 2>/dev/null || true
          sudo rm -f /swapfile
          sudo fallocate -l 8G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile

      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Generate RTLIL
        run: |
          cd designs/mcu_soc_sky130
          uv sync
          uv run chipflow silicon prepare

      - name: Install CF_SRAM IP
        run: uv run --with cf-ipm -- ipm install CF_SRAM_1024x32

      - name: Install SKY130 PDK via volare
        run: |
          uv tool install volare
          volare enable --pdk sky130 c6d73a35f524070e85faff4a6a9eef49553ebc2b

      - name: Pull librelane image
        run: docker pull ghcr.io/robtaylor/librelane:dev-x86_64

      - name: Synthesis (Yosys)
        run: |
          docker run --rm \
            -v "$PWD/designs/mcu_soc_sky130/build:/design" \
            -v "$PWD/sram:/sram:ro" \
            -v "$PWD/scripts/openlane2/synth.ys:/design/synth.ys:ro" \
            -v "$HOME/.volare:/root/.volare:ro" \
            ghcr.io/robtaylor/librelane:dev-x86_64 \
            yosys /design/synth.ys

      - name: Place and Route (librelane)
        id: pnr
        continue-on-error: true
        run: |
          docker run --rm \
            -v "$PWD/designs/mcu_soc_sky130/build:/design" \
            -v "$PWD/sram:/sram:ro" \
            -v "$PWD/ip/CF_SRAM_1024x32:/sram_ip:ro" \
            -v "$PWD/scripts/openlane2/mcu_soc_config.json:/design/config.json:ro" \
            -w /design \
            ghcr.io/robtaylor/librelane:dev-x86_64 \
            librelane /design/config.json

      - name: Extract artifacts
        run: |
          RUN_DIR=$(find designs/mcu_soc_sky130/build/runs -maxdepth 1 -name 'RUN_*' -type d | sort -r | head -1)
          echo "Using run directory: $RUN_DIR"

          # Show directory structure for debugging
          echo "=== Top-level directories ==="
          ls -la "$RUN_DIR"/ 2>/dev/null || true
          echo "=== All Verilog files ==="
          find "$RUN_DIR" -name '*.v' 2>/dev/null | head -20 || true
          echo "=== All SDF files ==="
          find "$RUN_DIR" -name '*.sdf' 2>/dev/null | head -10 || true
          echo "==="

          # Try final netlist first, fall back to intermediate step output.
          # Librelane only populates final/ after all sign-off checks pass;
          # the antenna check crashes on SRAM LEF missing gate info, but the
          # post-route netlist is functionally identical for simulation.
          #
          # IMPORTANT: Avoid the post-fill-insertion netlist (step 48) which
          # includes ~4M filler/decap instances (200+ MB). Use the detailed
          # routing netlist (step 40) which is functionally identical for
          # simulation at ~5 MB.
          if ls "$RUN_DIR"/final/nl/*.nl.v 1>/dev/null 2>&1; then
            echo "Using final netlist"
            cp "$RUN_DIR"/final/nl/*.nl.v tests/mcu_soc/data/6_final_raw.v
          else
            echo "::warning::final/nl/ not found, searching for intermediate netlist"
            # Prefer post-routing netlist (before fill insertion adds millions of filler cells)
            LAST_NL=$(find "$RUN_DIR" -path '*detailedrouting*' -name '*.nl.v' 2>/dev/null | sort -r | head -1)
            # Fall back to any .nl.v except fill insertion
            if [ -z "$LAST_NL" ]; then
              LAST_NL=$(find "$RUN_DIR" -name '*.nl.v' -not -path '*fillinsertion*' 2>/dev/null | sort -r | head -1)
            fi
            # Last resort: any .nl.v
            if [ -z "$LAST_NL" ]; then
              LAST_NL=$(find "$RUN_DIR" -name '*.nl.v' 2>/dev/null | sort -r | head -1)
            fi
            if [ -z "$LAST_NL" ]; then
              echo "::error::No netlist found in any P&R step."
              echo "::error::P&R may have failed before generating output."
              find "$RUN_DIR" -type f | head -50
              exit 1
            fi
            NL_SIZE=$(du -h "$LAST_NL" | cut -f1)
            echo "Using intermediate netlist: $LAST_NL ($NL_SIZE)"
            cp "$LAST_NL" tests/mcu_soc/data/6_final_raw.v
          fi

          # SDF timing (nom corner)
          if ls "$RUN_DIR"/final/sdf/*.sdf 1>/dev/null 2>&1; then
            cp "$RUN_DIR"/final/sdf/*.sdf tests/mcu_soc/data/6_final.sdf
          else
            LAST_SDF=$(find "$RUN_DIR" -name '*.sdf' 2>/dev/null | sort -r | head -1)
            [ -n "$LAST_SDF" ] && cp "$LAST_SDF" tests/mcu_soc/data/6_final.sdf || true
          fi

          # SDC constraints
          cp "$RUN_DIR"/final/sdc/*.sdc tests/mcu_soc/data/6_final.sdc 2>/dev/null || true

          # Pre-P&R netlist (post-synthesis)
          cp designs/mcu_soc_sky130/build/top_synth.v tests/mcu_soc/data/top_synth.v

      - name: Wrap netlist
        run: |
          uv run scripts/wrap_openframe.py \
            designs/mcu_soc_sky130/pins.lock \
            tests/mcu_soc/data/6_final_raw.v \
            tests/mcu_soc/data/6_final.v
          rm tests/mcu_soc/data/6_final_raw.v

      - name: Report artifact sizes
        run: |
          {
            echo "## MCU SoC Rebuild Artifacts"
            echo "| File | Size |"
            echo "|------|------|"
            for f in tests/mcu_soc/data/*; do
              if [ -f "$f" ]; then
                SIZE=$(du -h "$f" | cut -f1)
                echo "| \`$(basename "$f")\` | $SIZE |"
              fi
            done
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Create or update PR
        uses: peter-evans/create-pull-request@v7
        with:
          branch: auto/update-mcu-soc-data
          commit-message: "Update MCU SoC test data from librelane rebuild"
          title: "Update MCU SoC post-P&R test data"
          body: |
            Automated rebuild of `tests/mcu_soc/data/` using librelane.

            **Trigger:** `${{ github.event_name }}`

            The `mcu-soc-metal` CI job will validate simulation.
          labels: automated
          delete-branch: true
          add-paths: tests/mcu_soc/data/
